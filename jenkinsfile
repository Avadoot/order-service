node {
    checkout scm

    stage('Build & Test') {
        sh 'mvn clean install'
    }

    stage('build and release artifact') {
        sh 'mvn -Dresume=false -DdryRun=true release:prepare -Darguments="-DskipTests"'
        sh 'mvn -Dresume=false release:prepare release:perform -Darguments="-DskipTests"'
    }

    stage('Publish Pact to pact broker') {
        def pactBrockerCli = "/usr/share/jenkins/ref/pact/bin/pact-broker"
        def artifactFile = findFiles glob: '**/order-service*.jar'
        def m = (artifactFile[0].name =~ /^order-service-([0-9\.]+).jar/)
        def versionNo = m.find()?m.group(1):"not matched"
        sh "${pactBrockerCli} publish target/pacts --consumer-app-version=${versionNo} --broker-base-url=http://broker_app"
    }

    stage('Deploy') {
        echo 'deploy'
    }
}